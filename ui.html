<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Design System Coverage</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      padding: 20px;
      background: #ffffff;
      color: #333;
    }

    h1 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #000;
    }

    .subtitle {
      font-size: 11px;
      color: #666;
      margin-bottom: 16px;
    }

    .loading {
      text-align: center;
      padding: 40px 0;
      color: #666;
    }

    .metric-card {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .metric-header {
      font-size: 11px;
      font-weight: 500;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #000;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 11px;
      color: #888;
    }

    .overall-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-bottom: 16px;
    }

    .overall-card .metric-header {
      color: rgba(255, 255, 255, 0.8);
    }

    .overall-card .metric-value {
      color: white;
    }

    .overall-card .metric-label {
      color: rgba(255, 255, 255, 0.7);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }

    .stat-item {
      background: #fafafa;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #e5e5e5;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: #000;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 10px;
      color: #666;
      line-height: 1.3;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      gap: 8px;
    }

    button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #18a0fb;
      color: white;
    }

    .btn-primary:hover {
      background: #0d8adb;
    }

    .btn-secondary {
      background: #e5e5e5;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d5d5d5;
    }

    .error {
      background: #fee;
      color: #c00;
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
      font-size: 11px;
    }

    .benchmark {
      margin-top: 16px;
      padding: 12px;
      background: #fff9e6;
      border-radius: 6px;
      border: 1px solid #ffe4a3;
    }

    .benchmark-title {
      font-size: 11px;
      font-weight: 600;
      color: #8b6914;
      margin-bottom: 6px;
    }

    .benchmark-text {
      font-size: 11px;
      color: #5c4a0f;
      line-height: 1.4;
    }

    .breakdown-section {
      margin-top: 20px;
    }

    .breakdown-title {
      font-size: 11px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .breakdown-item {
      margin-bottom: 10px;
    }

    .breakdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .breakdown-label {
      font-size: 11px;
      font-weight: 500;
      color: #333;
    }

    .breakdown-value {
      font-size: 11px;
      font-weight: 600;
      color: #667eea;
    }

    .breakdown-bar {
      height: 6px;
      background: #e5e5e5;
      border-radius: 3px;
      overflow: hidden;
    }

    .breakdown-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .breakdown-bar-fill.local {
      background: #95a5a6;
    }

    .formula-badge {
      display: inline-block;
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-family: 'Monaco', 'Courier New', monospace;
      margin-top: 6px;
      color: rgba(255, 255, 255, 0.9);
    }

    .formula-badge-light {
      display: inline-block;
      background: #e8e8e8;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-family: 'Monaco', 'Courier New', monospace;
      margin-top: 6px;
      color: #555;
    }

    .settings-panel {
      padding: 12px;
      background: #f8f8f8;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      margin-bottom: 16px;
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .settings-title {
      font-size: 12px;
      font-weight: 600;
      color: #333;
    }

    .library-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .library-item:hover {
      background: #f8f8f8;
      border-color: #c0c0c0;
    }

    .library-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .library-info {
      flex: 1;
    }

    .library-name {
      font-size: 12px;
      font-weight: 500;
      color: #000;
      margin-bottom: 4px;
    }

    .library-meta {
      font-size: 10px;
      color: #999;
      display: flex;
      gap: 12px;
    }

    .library-badge {
      background: #e8e8e8;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      color: #666;
    }

    .library-badge.has-variables {
      background: #e3f2fd;
      color: #1976d2;
    }

    .library-badge.has-components {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: #999;
      font-size: 11px;
      font-style: italic;
    }

    .settings-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <h1>Design System Coverage</h1>
  <p class="subtitle">Select frames/components to analyze ‚Ä¢ Component instances only</p>

  <div id="loading" class="loading">
    <div style="margin-bottom: 16px;">
      <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px;">Analyzing selection...</div>
      <div id="progress-step" style="font-size: 11px; color: #333; margin-bottom: 12px; min-height: 16px; font-weight: 500;">Initializing...</div>
      <div style="width: 100%; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
        <div id="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #18A0FB 0%, #0084D6 100%); transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);"></div>
      </div>
      <div id="progress-percent" style="font-size: 11px; color: #666; margin-top: 8px; text-align: center; font-weight: 500;">0%</div>
    </div>
  </div>

  <div id="settings" style="display: none;">
    <div class="settings-panel">
      <div class="settings-header">
        <div class="settings-title">Connect Team Libraries</div>
      </div>
      <div style="margin-bottom: 12px; font-size: 11px; color: #666;">
        Enable the libraries you want to track. Variables and components from enabled libraries will be automatically detected and categorized.
      </div>
      <div id="librariesList">
        <div class="empty-state">Loading libraries...</div>
      </div>
      <div class="settings-actions">
        <button class="btn-primary btn-small" onclick="saveLibraries()">Save & Apply</button>
        <button class="btn-secondary btn-small" onclick="cancelSettings()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="results" style="display: none;">
    <div class="metric-card overall-card">
      <div class="metric-header">Design System Adoption</div>
      <div class="metric-value" id="overallScore">--</div>
      <div class="metric-label">Foundation-First weighted formula (Variables 55%, Components 45%)</div>
      <div class="formula-badge" id="formulaBadge">--</div>
    </div>

    <div class="metric-card">
      <div class="metric-header">Component Coverage</div>
      <div class="metric-value" id="componentScore">--</div>
      <div class="metric-label">DS Component Instances / (DS + Custom Components)</div>
      <div class="formula-badge-light" id="componentFormula">--</div>
    </div>

    <div class="metric-card">
      <div class="metric-header">Token Adoption</div>
      <div class="metric-value" id="variableScore">--</div>
      <div class="metric-label">Components with Variables / Total Components</div>
      <div class="formula-badge-light" id="variableFormula">--</div>
    </div>

    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-value" id="libraryInstances">--</div>
        <div class="stat-label">Spandex - Atomic</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="localInstances">--</div>
        <div class="stat-label">Local Components</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="nodesWithVariables">--</div>
        <div class="stat-label">With Variables</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="nodesWithCustom">--</div>
        <div class="stat-label">Without Variables</div>
      </div>
    </div>

    <div class="breakdown-section">
      <div class="breakdown-title">Component Sources</div>
      <div id="libraryBreakdown"></div>
    </div>

    <div class="breakdown-section">
      <div class="breakdown-title">Variable Sources</div>
      <div id="variableBreakdown"></div>
    </div>

    <div class="breakdown-section">
      <div class="breakdown-title">Hardcoded Values (Should Use Variables)</div>
      <div id="hardcodedBreakdown"></div>
    </div>

    <div id="benchmark" class="benchmark" style="display: none;">
      <div class="benchmark-title">Benchmark</div>
      <div class="benchmark-text" id="benchmarkText"></div>
    </div>

    <div class="actions">
      <button class="btn-primary" onclick="refresh()">Analyze Selection</button>
      <button class="btn-secondary" onclick="showSettings()">‚öôÔ∏è Settings</button>
      <button class="btn-secondary" onclick="close()">Close</button>
    </div>
  </div>

  <div id="error" style="display: none;" class="error"></div>

  <div id="empty-selection" style="display: none;">
    <div style="text-align: center; padding: 40px 20px;">
      <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">üìê</div>
      <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px;">
        No Selection
      </div>
      <div style="font-size: 13px; color: #666; line-height: 1.5; margin-bottom: 24px;">
        Select one or more frames, components, or sections on your canvas to analyze design system coverage.
      </div>
      <button class="btn-primary" id="analyzeBtn" disabled style="opacity: 0.5; cursor: not-allowed;">
        Analyze Selection
      </button>
      <div style="margin-top: 16px;">
        <button class="btn-secondary" onclick="showSettings()">‚öôÔ∏è Settings</button>
        <button class="btn-secondary" onclick="close()">Close</button>
      </div>
    </div>
  </div>

  <script>
    let availableLibraries = [];
    let currentData = null; // Store current analysis data
    let ignoredComponentsSet = new Set(); // Track ignored components
    let ignoredOrphansSet = new Set(); // Track ignored individual orphans by nodeId
    let orphanDetailsOpen = false; // Track accordion state
    let lastLoadedData = null; // Track if we've received new data from backend

    // Icon SVG for select buttons
    const locationIconSVG = `<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M6 1C4.067 1 2.5 2.567 2.5 4.5C2.5 7.125 6 11 6 11C6 11 9.5 7.125 9.5 4.5C9.5 2.567 7.933 1 6 1Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="6" cy="4.5" r="1" fill="currentColor"/>
    </svg>`;

    function formatPercent(value) {
      return Math.round(value) + '%';
    }

    function getBenchmark(score) {
      // Research-backed benchmarks from industry leaders (IBM, Atlassian, Pinterest)
      if (score < 40) {
        return 'Early adoption or struggling system. Requires intervention‚Äîlikely missing key components, poor documentation, or lack of organizational support. Focus on proving value to a few teams first.';
      } else if (score < 60) {
        return 'Healthy early growth (Industry: 40-60%). Focus on education, adding missing components, gathering feedback, and demonstrating value. IBM Carbon achieved 44.8% within 10 months.';
      } else if (score < 80) {
        return 'Strong momentum (Industry: 60-80%). Focus on remaining holdouts, migration from legacy, optimization, and contribution models. Typical growth: 7-10 percentage points per quarter.';
      } else if (score < 95) {
        return 'Mature success (Industry: 80-95%). Focus on sustainability, continuous improvement, keeping pace with platform changes, and measuring quality metrics beyond adoption. Atlassian targets 95%.';
      } else {
        return 'Exceptional achievement (>95%)! You\'re at industry-leading adoption levels. Airbnb achieved near 100% after full maturity. Note: 100% adoption is neither realistic nor desirable‚Äîlegitimate exceptions exist.';
      }
    }

    function displayResults(data) {
      const { componentCoverage, variableCoverage, stats, libraryBreakdown, variableBreakdown, hardcodedValues } = data;

      // Check if this is NEW data from backend (new analysis) or re-render with same data (from toggle)
      const isNewData = (data !== lastLoadedData);

      // Store scroll position before re-rendering
      const orphanDetailsEl = document.getElementById('orphan-details');
      const scrollPos = orphanDetailsEl ? orphanDetailsEl.scrollTop : 0;

      // Store data for filtering
      currentData = data;

      // IMPORTANT: Only load ignoredComponents/Orphans from backend when we receive NEW data
      // Don't overwrite local changes when re-rendering from checkbox toggles
      if (isNewData && hardcodedValues) {
        if (hardcodedValues.ignoredComponents) {
          ignoredComponentsSet = new Set(hardcodedValues.ignoredComponents);
        }
        if (hardcodedValues.ignoredOrphans) {
          ignoredOrphansSet = new Set(hardcodedValues.ignoredOrphans);
        }
        lastLoadedData = data;
        console.log('‚úì New data from backend - loaded ignored items');
      } else {
        console.log('‚úì Re-render - keeping local ignored sets');
      }

      // Foundation-First Weighting (Research-backed formula)
      // Variables (foundation) 55%, Components 45%
      // Based on industry research: foundational elements (tokens/variables) drive 80% of consistency value
      const overallScore = (variableCoverage * 0.55) + (componentCoverage * 0.45);

      // Calculate Orphan Rate (quality metric)
      // Orphan Rate = Hardcoded Values / Total Opportunities
      // Industry target: <20% orphans
      let orphanRate = 0;
      if (hardcodedValues && hardcodedValues.totalOpportunities > 0) {
        orphanRate = (hardcodedValues.totalHardcoded / hardcodedValues.totalOpportunities) * 100;
      }

      // Update UI
      document.getElementById('overallScore').textContent = formatPercent(overallScore);
      document.getElementById('componentScore').textContent = formatPercent(componentCoverage);
      document.getElementById('variableScore').textContent = formatPercent(variableCoverage);

      // Update formula badges with actual calculations (Foundation-First methodology)
      const overallFormula = `(Vars ${Math.round(variableCoverage)}% √ó 0.55) + (Comps ${Math.round(componentCoverage)}% √ó 0.45) = ${Math.round(overallScore)}%`;
      document.getElementById('formulaBadge').textContent = overallFormula;

      const totalInstances = stats.libraryInstances + stats.localInstances;
      const componentFormula = totalInstances > 0
        ? `DS Components / (DS + Local) = ${stats.libraryInstances} / ${totalInstances} = ${Math.round(componentCoverage)}%`
        : 'No components found';
      document.getElementById('componentFormula').textContent = componentFormula;

      const totalComponents = stats.nodesWithVariables + stats.nodesWithCustomStyles;
      const variableFormula = totalComponents > 0
        ? `With Vars / Total = ${stats.nodesWithVariables} / ${totalComponents} = ${Math.round(variableCoverage)}%`
        : 'No components analyzed';
      document.getElementById('variableFormula').textContent = variableFormula;

      document.getElementById('libraryInstances').textContent = stats.libraryInstances;
      document.getElementById('localInstances').textContent = stats.localInstances;
      document.getElementById('nodesWithVariables').textContent = stats.nodesWithVariables;
      document.getElementById('nodesWithCustom').textContent = stats.nodesWithCustomStyles;

      // Display library breakdown
      const breakdownEl = document.getElementById('libraryBreakdown');
      console.log('Breakdown data:', libraryBreakdown);

      if (libraryBreakdown && libraryBreakdown.length > 0) {
        const html = libraryBreakdown.map(lib => {
          const isLocal = lib.name === 'Local Components';
          const fillClass = isLocal ? 'local' : '';
          return `
            <div class="breakdown-item">
              <div class="breakdown-header">
                <span class="breakdown-label">${lib.name}</span>
                <span class="breakdown-value">${lib.count} (${formatPercent(lib.percentage)})</span>
              </div>
              <div class="breakdown-bar">
                <div class="breakdown-bar-fill ${fillClass}" style="width: ${lib.percentage}%"></div>
              </div>
            </div>
          `;
        }).join('');
        breakdownEl.innerHTML = html;
        console.log('Breakdown HTML set');
      } else {
        breakdownEl.innerHTML = '<p style="font-size: 11px; color: #999; font-style: italic;">No components found on this page</p>';
        console.log('No breakdown data available');
      }

      // Display variable breakdown
      const variableBreakdownEl = document.getElementById('variableBreakdown');
      console.log('Variable breakdown data:', variableBreakdown);

      if (variableBreakdown && variableBreakdown.length > 0) {
        const html = variableBreakdown.map(lib => {
          const isOther = lib.name.includes('Other Library');
          const fillClass = isOther ? 'local' : '';
          return `
            <div class="breakdown-item">
              <div class="breakdown-header">
                <span class="breakdown-label">${lib.name}</span>
                <span class="breakdown-value">${lib.count} (${formatPercent(lib.percentage)})</span>
              </div>
              <div class="breakdown-bar">
                <div class="breakdown-bar-fill ${fillClass}" style="width: ${lib.percentage}%"></div>
              </div>
            </div>
          `;
        }).join('');
        variableBreakdownEl.innerHTML = html;
        console.log('Variable breakdown HTML set');
      } else {
        variableBreakdownEl.innerHTML = '<p style="font-size: 11px; color: #999; font-style: italic;">No variables found on this page</p>';
        console.log('No variable breakdown data available');
      }

      // Display hardcoded values breakdown (Orphan Rate metric)
      const hardcodedBreakdownEl = document.getElementById('hardcodedBreakdown');
      if (data.hardcodedValues) {
        const hv = data.hardcodedValues;

        // Orphan Rate is a key quality metric from research
        // Target: <20% orphans (industry standard)
        const orphanRateColor = orphanRate < 20 ? '#2ecc71' : orphanRate < 40 ? '#f39c12' : '#e74c3c';
        const orphanStatus = orphanRate < 20 ? '‚úì Excellent' : orphanRate < 40 ? '‚ö† Needs Improvement' : '‚úó Poor';

        const hardcodedData = [
          { label: 'Colors', count: hv.colors, color: '#e74c3c' },
          { label: 'Typography', count: hv.typography, color: '#3498db' },
          { label: 'Spacing', count: hv.spacing, color: '#2ecc71' },
          { label: 'Radius', count: hv.radius, color: '#f39c12' },
        ].filter(item => item.count > 0);

        if (hardcodedData.length > 0) {
          const html = hardcodedData.map(item => {
            const percentage = hv.totalHardcoded > 0 ? (item.count / hv.totalHardcoded) * 100 : 0;
            return `
              <div class="breakdown-item">
                <div class="breakdown-header">
                  <span class="breakdown-label">${item.label}</span>
                  <span class="breakdown-value">${item.count} (${formatPercent(percentage)})</span>
                </div>
                <div class="breakdown-bar">
                  <div class="breakdown-bar-fill" style="width: ${percentage}%; background: ${item.color};"></div>
                </div>
              </div>
            `;
          }).join('');

          // Build detailed orphan list
          let detailsHtml = '';
          if (hv.details && hv.details.length > 0) {
            const categoryColors = {
              colors: '#e74c3c',
              typography: '#3498db',
              spacing: '#2ecc71',
              radius: '#f39c12'
            };

            // Group orphans by parent component (keep ignored ones in the list)
            const orphansByComponent = new Map();
            let filteredOrphanCount = 0;
            const filteredHardcodedCounts = { colors: 0, typography: 0, spacing: 0, radius: 0 };

            hv.details.forEach(detail => {
              const compId = detail.parentComponentId;
              const isComponentIgnored = ignoredComponentsSet.has(compId);
              const isOrphanIgnored = ignoredOrphansSet.has(detail.nodeId);

              // Always add to the map, but only count if not ignored (component OR orphan)
              if (!isComponentIgnored && !isOrphanIgnored) {
                filteredOrphanCount++;

                // Count hardcoded properties by category (only for non-ignored)
                const propCount = detail.properties.length;
                filteredHardcodedCounts[detail.category] += propCount;
              }

              if (!orphansByComponent.has(compId)) {
                orphansByComponent.set(compId, {
                  name: detail.parentComponentName,
                  id: compId,
                  orphans: []
                });
              }
              orphansByComponent.get(compId).orphans.push(detail);
            });

            // Recalculate totals based on filtered orphans
            const filteredTotalHardcoded = Object.values(filteredHardcodedCounts).reduce((sum, val) => sum + val, 0);

            // When ignoring components, we only remove their hardcoded properties
            // The token-bound count stays the same (we're just saying "ignore these orphans")
            const tokenBoundCount = hv.totalOpportunities - hv.totalHardcoded;
            const filteredTotalOpportunities = tokenBoundCount + filteredTotalHardcoded;

            // Recalculate token adoption percentage
            const filteredVariableCoverage = filteredTotalOpportunities > 0
              ? (tokenBoundCount / filteredTotalOpportunities) * 100
              : 0;
            const filteredOrphanRate = filteredTotalOpportunities > 0
              ? (filteredTotalHardcoded / filteredTotalOpportunities) * 100
              : 0;
            const filteredOverallScore = (filteredVariableCoverage * 0.55) + (componentCoverage * 0.45);

            // Update displayed metrics with filtered values
            const overallScoreEl = document.getElementById('overallScore');
            const variableScoreEl = document.getElementById('variableScore');

            if (overallScoreEl && variableScoreEl) {
              overallScoreEl.textContent = formatPercent(filteredOverallScore);
              variableScoreEl.textContent = formatPercent(filteredVariableCoverage);
            }

            // Update formula badges with filtered calculations
            const filteredOverallFormula = `(Vars ${Math.round(filteredVariableCoverage)}% √ó 0.55) + (Comps ${Math.round(componentCoverage)}% √ó 0.45) = ${Math.round(filteredOverallScore)}%`;
            document.getElementById('formulaBadge').textContent = filteredOverallFormula;

            const filteredVariableFormula = filteredTotalOpportunities > 0
              ? `Token-bound / Total Properties = ${tokenBoundCount} / ${filteredTotalOpportunities} = ${Math.round(filteredVariableCoverage)}%`
              : 'No properties analyzed';
            document.getElementById('variableFormula').textContent = filteredVariableFormula;

            const detailsList = Array.from(orphansByComponent.values()).map(component => {
              const isIgnored = ignoredComponentsSet.has(component.id);
              const opacityStyle = isIgnored ? 'opacity: 0.5;' : '';
              const bgColor = isIgnored ? '#f9f9f9' : '#f5f5f5';
              const orphanItems = component.orphans.map(detail => {
                const isOrphanIgnored = ignoredOrphansSet.has(detail.nodeId);
                const orphanOpacity = isOrphanIgnored ? 'opacity: 0.4;' : '';
                const color = categoryColors[detail.category] || '#666';
                const propertiesList = detail.properties.map((prop, i) => {
                  const value = detail.values && detail.values[i] ? ` (${detail.values[i]})` : '';
                  return `<span style="color: ${color}; font-weight: 500;">${prop}</span>${value}`;
                }).join(', ');

                return `
                  <div style="padding: 8px; margin-bottom: 6px; background: #fff; border-radius: 4px; font-size: 10px; ${orphanOpacity}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                      <div style="font-weight: 600; color: #333; flex: 1;">${detail.nodeName}</div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="display: flex; align-items: center; font-size: 10px; color: #666;">
                          <input
                            type="checkbox"
                            id="ignore-orphan-${detail.nodeId}"
                            ${isOrphanIgnored ? 'checked' : ''}
                            onchange="toggleIgnoreOrphan('${detail.nodeId}', event)"
                            style="margin-right: 4px; cursor: pointer;"
                          />
                          <label for="ignore-orphan-${detail.nodeId}" style="cursor: pointer; user-select: none; font-size: 9px;">Ignore</label>
                        </div>
                        <button
                          onclick="selectNode('${detail.nodeId}')"
                          title="Select in Figma"
                          style="padding: 4px 6px; background: #18A0FB; color: white; border: none; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                          onmouseover="this.style.background='#0D8ADB'"
                          onmouseout="this.style.background='#18A0FB'"
                        >
                          ${locationIconSVG}
                        </button>
                      </div>
                    </div>
                    <div style="color: #666; margin-bottom: 2px;"><span style="opacity: 0.7;">Type:</span> ${detail.nodeType}</div>
                    <div style="color: #666;"><span style="opacity: 0.7;">Hardcoded:</span> ${propertiesList}</div>
                  </div>
                `;
              }).join('');

              return `
                <div style="margin-bottom: 12px; border: 1px solid ${isIgnored ? '#d0d0d0' : '#e0e0e0'}; border-radius: 6px; overflow: hidden; ${opacityStyle}">
                  <div style="background: ${bgColor}; padding: 10px; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                    <div style="flex: 1;">
                      <div style="font-weight: 600; color: #333; font-size: 11px;">${component.name} ${isIgnored ? '(Ignored)' : ''}</div>
                      <div style="font-size: 10px; color: #666; margin-top: 2px;">${component.orphans.length} orphan${component.orphans.length > 1 ? 's' : ''}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <div style="display: flex; align-items: center; font-size: 10px; color: #666;">
                        <input
                          type="checkbox"
                          id="ignore-${component.id}"
                          ${isIgnored ? 'checked' : ''}
                          onchange="toggleIgnoreComponent('${component.id}', event)"
                          style="margin-right: 6px; cursor: pointer;"
                        />
                        <label for="ignore-${component.id}" style="cursor: pointer; user-select: none;">Ignore</label>
                      </div>
                      <button
                        onclick="selectNode('${component.id}')"
                        title="Select parent component in Figma"
                        style="padding: 4px 6px; background: #18A0FB; color: white; border: none; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                        onmouseover="this.style.background='#0D8ADB'"
                        onmouseout="this.style.background='#18A0FB'"
                      >
                        ${locationIconSVG}
                      </button>
                    </div>
                  </div>
                  <div style="padding: 8px; background: #fafafa;">
                    ${orphanItems}
                  </div>
                </div>
              `;
            }).join('');

            const countText = filteredOrphanCount < hv.details.length
              ? `${filteredOrphanCount} nodes (${hv.details.length - filteredOrphanCount} ignored)`
              : `${filteredOrphanCount} nodes`;

            detailsHtml = `
              <div style="margin-top: 12px;">
                <div onclick="toggleOrphanDetails()" style="cursor: pointer; padding: 8px 12px; background: #f0f0f0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 11px; font-weight: 600; color: #333;">üìã View Details (${countText})</span>
                  <span id="orphan-details-arrow" style="font-size: 10px; color: #666;">${orphanDetailsOpen ? '‚ñ≤' : '‚ñº'}</span>
                </div>
                <div id="orphan-details" style="display: ${orphanDetailsOpen ? 'block' : 'none'}; max-height: 300px; overflow-y: auto; margin-top: 8px; padding: 8px; background: #fafafa; border-radius: 4px;">
                  ${detailsList}
                  ${hv.details.length >= 100 ? '<div style="font-size: 10px; color: #999; font-style: italic; text-align: center; padding: 8px;">Showing first 100 orphans</div>' : ''}
                </div>
              </div>
            `;
          }

          hardcodedBreakdownEl.innerHTML = html +
            `<div style="margin-top: 16px; padding: 12px; background: ${orphanRateColor}15; border-left: 3px solid ${orphanRateColor}; border-radius: 4px;">
              <div style="font-size: 11px; font-weight: 600; color: ${orphanRateColor}; margin-bottom: 4px;">
                Orphan Rate: ${Math.round(orphanRate)}% ${orphanStatus}
              </div>
              <div style="font-size: 10px; color: #666;">
                ${hv.totalHardcoded} hardcoded values / ${hv.totalOpportunities} total properties (Target: <20%)
              </div>
            </div>` + detailsHtml;
        } else {
          hardcodedBreakdownEl.innerHTML = `
            <div style="padding: 12px; background: #2ecc7115; border-left: 3px solid #2ecc71; border-radius: 4px;">
              <div style="font-size: 11px; font-weight: 600; color: #2ecc71; margin-bottom: 4px;">
                ‚úì Orphan Rate: 0% - Excellent!
              </div>
              <div style="font-size: 10px; color: #666;">
                No hardcoded values detected. Perfect variable adoption!
              </div>
            </div>`;
        }
      } else {
        hardcodedBreakdownEl.innerHTML = '<p style="font-size: 11px; color: #999; font-style: italic;">Hardcoded value detection not available</p>';
      }

      // Show benchmark
      const benchmarkEl = document.getElementById('benchmark');
      const benchmarkText = document.getElementById('benchmarkText');
      benchmarkText.textContent = getBenchmark(overallScore);
      benchmarkEl.style.display = 'block';

      // Show results, hide loading
      document.getElementById('loading').style.display = 'none';
      document.getElementById('results').style.display = 'block';
      document.getElementById('error').style.display = 'none';
      document.getElementById('empty-selection').style.display = 'none';

      // Restore scroll position after render
      requestAnimationFrame(() => {
        const restoredEl = document.getElementById('orphan-details');
        if (restoredEl && scrollPos > 0) {
          restoredEl.scrollTop = scrollPos;
        }
      });
    }

    function displayError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = 'Error: ' + message;
      errorEl.style.display = 'block';
      document.getElementById('loading').style.display = 'none';
      document.getElementById('empty-selection').style.display = 'none';
    }

    function refresh() {
      // Reset progress state
      currentProgress = 0;
      const progressBar = document.getElementById('progress-bar');
      const progressStep = document.getElementById('progress-step');
      const progressPercent = document.getElementById('progress-percent');
      if (progressBar) progressBar.style.width = '0%';
      if (progressStep) progressStep.textContent = 'Initializing...';
      if (progressPercent) progressPercent.textContent = '0%';

      document.getElementById('loading').style.display = 'block';
      document.getElementById('results').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('empty-selection').style.display = 'none';
      parent.postMessage({ pluginMessage: { type: 'analyze' } }, '*');
    }

    function close() {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    }

    function showSettings() {
      // Request libraries data from plugin
      parent.postMessage({ pluginMessage: { type: 'get-libraries' } }, '*');
    }

    function cancelSettings() {
      document.getElementById('settings').style.display = 'none';
      // Check if we have results to show, otherwise show empty selection
      const results = document.getElementById('results');
      const emptySelection = document.getElementById('empty-selection');
      const overallScore = document.getElementById('overallScore').textContent;

      if (overallScore && overallScore !== '--') {
        results.style.display = 'block';
      } else {
        emptySelection.style.display = 'block';
      }
    }

    function displaySettings(libraries) {
      availableLibraries = libraries;

      const librariesList = document.getElementById('librariesList');

      if (libraries.length === 0) {
        librariesList.innerHTML = '<div class="empty-state">No team libraries found.</div>';
      } else {
        const html = libraries.map(lib => {
          const badges = [];
          if (lib.hasVariables) badges.push('<span class="library-badge has-variables">Variables</span>');
          if (lib.hasComponents) badges.push('<span class="library-badge has-components">Components</span>');

          return `
            <div class="library-item" onclick="toggleLibrary('${lib.key}')">
              <input
                type="checkbox"
                class="library-checkbox"
                id="lib-${lib.key}"
                data-key="${lib.key}"
                ${lib.enabled ? 'checked' : ''}
                onclick="event.stopPropagation();"
              />
              <div class="library-info">
                <div class="library-name">${lib.name}</div>
                <div class="library-meta">
                  ${badges.join('')}
                </div>
              </div>
            </div>
          `;
        }).join('');
        librariesList.innerHTML = html;
      }

      document.getElementById('results').style.display = 'none';
      document.getElementById('empty-selection').style.display = 'none';
      document.getElementById('settings').style.display = 'block';
    }

    function toggleLibrary(key) {
      const checkbox = document.getElementById(`lib-${key}`);
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
      }
    }

    function toggleOrphanDetails() {
      const details = document.getElementById('orphan-details');
      const arrow = document.getElementById('orphan-details-arrow');
      if (details && arrow) {
        if (details.style.display === 'none') {
          details.style.display = 'block';
          arrow.textContent = '‚ñ≤';
          orphanDetailsOpen = true;
        } else {
          details.style.display = 'none';
          arrow.textContent = '‚ñº';
          orphanDetailsOpen = false;
        }
      }
    }

    function selectNode(nodeId) {
      parent.postMessage({
        pluginMessage: {
          type: 'select-node',
          nodeId: nodeId
        }
      }, '*');
    }

    function toggleIgnoreComponent(componentId, event) {
      // Stop propagation to prevent any parent click handlers
      if (event) {
        event.stopPropagation();
      }

      // Toggle in local set
      if (ignoredComponentsSet.has(componentId)) {
        ignoredComponentsSet.delete(componentId);
        // Send unignore message to backend
        parent.postMessage({
          pluginMessage: {
            type: 'unignore-component',
            componentId: componentId
          }
        }, '*');
      } else {
        ignoredComponentsSet.add(componentId);
        // Send ignore message to backend
        parent.postMessage({
          pluginMessage: {
            type: 'ignore-component',
            componentId: componentId
          }
        }, '*');
      }

      // Re-render with updated filter (no re-analysis needed)
      if (currentData) {
        displayResults(currentData);
      }
    }

    function toggleIgnoreOrphan(nodeId, event) {
      // Stop propagation to prevent any parent click handlers
      if (event) {
        event.stopPropagation();
      }

      // Toggle in local set
      if (ignoredOrphansSet.has(nodeId)) {
        ignoredOrphansSet.delete(nodeId);
        // Send unignore message to backend
        parent.postMessage({
          pluginMessage: {
            type: 'unignore-orphan',
            nodeId: nodeId
          }
        }, '*');
      } else {
        ignoredOrphansSet.add(nodeId);
        // Send ignore message to backend
        parent.postMessage({
          pluginMessage: {
            type: 'ignore-orphan',
            nodeId: nodeId
          }
        }, '*');
      }

      // Re-render with updated filter (no re-analysis needed)
      if (currentData) {
        displayResults(currentData);
      }
    }

    function saveLibraries() {
      const enabledLibraries = [];
      const checkboxes = document.querySelectorAll('.library-checkbox');

      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          enabledLibraries.push(checkbox.getAttribute('data-key'));
        }
      });

      parent.postMessage({
        pluginMessage: {
          type: 'save-libraries',
          libraries: enabledLibraries
        }
      }, '*');

      // Return to results view
      cancelSettings();

      // Trigger a refresh to see updated categorization
      refresh();
    }

    // Handle selection status updates
    function handleSelectionStatus(hasSelection, count) {
      const analyzeBtn = document.getElementById('analyzeBtn');
      const emptySelection = document.getElementById('empty-selection');
      const loading = document.getElementById('loading');
      const results = document.getElementById('results');
      const error = document.getElementById('error');
      const settings = document.getElementById('settings');

      if (hasSelection) {
        // Enable analyze button
        analyzeBtn.disabled = false;
        analyzeBtn.style.opacity = '1';
        analyzeBtn.style.cursor = 'pointer';
        analyzeBtn.textContent = `Analyze Selection (${count} item${count > 1 ? 's' : ''})`;
        analyzeBtn.onclick = refresh;

        // If we're in empty-selection view, stay there but with enabled button
        // Otherwise keep current view
        if (emptySelection.style.display !== 'none') {
          // Keep empty selection view but with enabled button
        }
      } else {
        // Disable analyze button and show empty selection view
        analyzeBtn.disabled = true;
        analyzeBtn.style.opacity = '0.5';
        analyzeBtn.style.cursor = 'not-allowed';
        analyzeBtn.textContent = 'Analyze Selection';
        analyzeBtn.onclick = null;

        // Show empty selection view, hide others
        emptySelection.style.display = 'block';
        loading.style.display = 'none';
        results.style.display = 'none';
        error.style.display = 'none';
        settings.style.display = 'none';
      }
    }

    // Listen for messages from plugin code
    let currentProgress = 0;
    function updateProgress(step, percent) {
      const stepEl = document.getElementById('progress-step');
      const barEl = document.getElementById('progress-bar');
      const percentEl = document.getElementById('progress-percent');

      // Only update if progress is moving forward (prevent jumps back)
      if (percent >= currentProgress) {
        currentProgress = percent;

        if (stepEl) {
          stepEl.textContent = step;
        }

        if (barEl) {
          barEl.style.width = percent + '%';
        }

        if (percentEl) {
          percentEl.textContent = Math.round(percent) + '%';
        }
      }
    }

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (msg.type === 'results') {
        displayResults(msg.data);
      } else if (msg.type === 'error') {
        displayError(msg.message);
      } else if (msg.type === 'libraries') {
        displaySettings(msg.libraries);
      } else if (msg.type === 'selection-status') {
        handleSelectionStatus(msg.hasSelection, msg.count);
      } else if (msg.type === 'progress') {
        updateProgress(msg.step, msg.percent);
      }
    };
  </script>
</body>
</html>
